apiVersion: batch/v1beta1
kind: CronJob
metadata:
  labels:
    app: auto-updater-cronjob
  name: auto-updater-cronjob
spec:
  schedule: {{ .Values.schedule | quote }}
  suspend: {{ .Values.suspend }}
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: auto-updater-job
        spec:

          serviceAccountName: auto-updater

          containers:
          - image: arne/kubectldocker
            name: auto-updater
            imagePullPolicy: Always

            # command: ["sleep", "356d"]
            command: ["sync-pods"]

            volumeMounts:
              - name: docker
                mountPath: /var/run/docker.sock
                readOnly: true

              - name: scripts
                mountPath: /usr/local/bin/sync-pods
                subPath: sync-pods

          volumes:
          - name: docker
            hostPath:
              path: /var/run/docker.sock

          - name: scripts
            configMap:
              name: auto-updater-scripts
              defaultMode: 0744

          restartPolicy: Never
      backoffLimit: 1
      activeDeadlineSeconds: 300
