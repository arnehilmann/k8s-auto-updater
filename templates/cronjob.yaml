apiVersion: batch/v1beta1
kind: CronJob
metadata:
  labels:
    app: auto-updater-cronjob
  name: auto-updater-cronjob
spec:
  schedule: {{ .Values.schedule | quote }}
  suspend: {{ .Values.suspend }}
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: auto-updater-job
            auto-update: never
        spec:

          serviceAccountName: auto-updater

          containers:
          - image: arne/kubectlskopeo
            name: auto-updater
            imagePullPolicy: Always

            command: ["sync-pods"]

            env:
              - name: POD_SELECTOR
                value: {{ .Values.podSelector | quote }}
              - name: IMAGE_REGEXP
                value: {{ .Values.imageRegExp | quote }}
              - name: NR_PODS_TO_DELETE
                value: {{ .Values.nrPodsToDelete | quote }}

            volumeMounts:
              - name: scripts
                mountPath: /usr/local/bin/sync-pods
                subPath: sync-pods

          volumes:
          - name: scripts
            configMap:
              name: auto-updater-scripts
              defaultMode: 0744

          restartPolicy: Never
      backoffLimit: 1
      activeDeadlineSeconds: {{ .Values.activeDeadlineSeconds }}
